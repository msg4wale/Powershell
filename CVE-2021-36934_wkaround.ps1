# Step 0, use Start-Transcript to capture the execution to a text file and set variables for connecting to Azure Table

Start-Transcript -Path "C:\TempLogs\CVE-2021-36934_workaround-$(((get-date).ToUniversalTime()).ToString("yyyyMMddThhmmssZ")).log"

function fix-cve36934{

# Step 1, Restrict access and delete shadow copies
    cd $env:windir\System32\

    $output = Invoke-Command -ScriptBlock {


    $op = .\icacls.exe $env:windir\system32\config\*.* /inheritance:e

    $op = $op[-1]

    return $op

    }

    Write-Host $output

    if ($output -match 'Successfully processed \d\d files; Failed processing 0 files'){
        Write-Host 'Access list suceffully updated'

    } else{
        Write-Host 'Unable to update access list'

    }

    $rest0 = Get-ComputerRestorePoint


    if ($rest0){

    
        $out = .\vssadmin.exe delete shadows /for='C:' /Quiet


    }

    # Step 2, Check Restore point is deleted
    $rest1 = Get-ComputerRestorePoint

    if (($out[-1] -match "No items found that satisfy the query.") -or ($out[-1] -eq "")){

        if (!$rest1){

        New-Item -Path 'C:\TempLogs\CVE-2021-36934-Success.status' -ItemType File
    
        Write-Host "Restore point Delete Successful"

        }

}

# Step 3, Create new restore point

Checkpoint-Computer -Description "After CVE-2021-36934 Workaround" -RestorePointType "MODIFY_SETTINGS"

$rest2 = Get-ComputerRestorePoint

Write-Host $rest2


}


# Step 4, Detect if script has applied before
$status = Test-Path -Path 'C:\TempLogs\CVE-2021-36934-Success.status' -PathType Leaf

if ($status){

Write-Host 'Issue already fixed'

} else{

fix-cve36934

}


Stop-Transcript
