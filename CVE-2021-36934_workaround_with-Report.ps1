# Step 0, use Start-Transcript to capture the execution to a text file and set variables for connecting to Azure Table

Start-Transcript -Path "C:\TempLogs\CVE-2021-36934_workaround-$(((get-date).ToUniversalTime()).ToString("yyyyMMddThhmmssZ")).log"

$storageAccountName = 'Storage account Name '
$tableName = 'PowershellReports'
$rowKey = ([guid]::NewGuid().tostring())
$storageAccountKey = <get access key form azure storage account>

If($storageAccountKey.GetType().Name -eq "StorageAccountKeys") {
    
    $storageAccountKey = $storageAccountKey.Key1
} Else {
    
    $storageAccountKey = $storageAccountKey[0].Value
}

$dateTime = get-date
$partitionKey = "partition1"



# Step 1, Install Az module
Install-PackageProvider -Name NuGet -Force -Verbose:$false -Confirm:$false
Install-Module -Name Aztable -Scope AllUsers -Force -ErrorAction Stop -Confirm:$false -Verbose:$false
Write-Host "Successfully installed Aztable"

Import-Module Aztable


# Step 2, Connect to Azure Table Storage
$storageCtx = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey
$table = (Get-AzStorageTable -Name $tableName -Context $storageCtx).CloudTable

# Step 3, Restrict access and delete shadow copies

cd $env:windir\System32\
$output = Invoke-Command -ScriptBlock {

$op = .\icacls $env:windir\system32\config\*.* /inheritance:e

$op = $op[-1]

return $op

}

Write-Host $output

if ($output -match 'Successfully processed \d\d files; Failed processing 0 files'){
    Write-Host 'Access list suceffully updated'

} else{
    Write-Host 'Unable to update access list'

}

$rest0 = Get-ComputerRestorePoint


if ($rest0){

    
    vssadmin delete shadows /for='C:' /Quiet

}

# Step 4, Check Restore point is deleted
$rest1 = Get-ComputerRestorePoint

if (!$rest1){

    
    $deleteStatus = "Successful"

}

# Step 5, Create new restore point

Checkpoint-Computer -Description "After CVE-2021-36934 Workaround" -RestorePointType "MODIFY_SETTINGS"

$rest2 = Get-ComputerRestorePoint

$rest2.CreationTime
$rest2.Description

# Step 6, Write data to Table Storage and end transcript.

Write-Host "Writing to Azure Table $table"


Add-AzTableRow -table $table -partitionKey $partitionKey -rowKey $rowKey -property @{"LocalHostname"=$env:computername;"DeleteStatus"=$deleteStatus;"CreationTime"=$rest2.CreationTime;"RestPointDesscription"=$rest2.Description}| Out-Null

Stop-Transcript
